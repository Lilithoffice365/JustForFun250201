#!/usr/bin/python3
# -- coding: utf-8 --
# -------------------------------
# @Author : github@wd210010 https://github.com/wd210010/just_for_happy
# @Time : 2023/2/27 13:23
# -------------------------------
# cron "6 * * *" script-path=xxx.py,tag=åŒ¹é…cronç”¨
# const $ = new Env('å–œé©¬æ‹‰é›…ç­¾åˆ°')

import requests, json ,os

# é’é¾™å˜é‡ xmly_cookieæŠ“åŒ…ç™»å½•xmly.comç›´æ¥æŠ“cookies
xmly_cookie = os.getenv("xmly_cookie").split('#')

# è·å–WxPusheré…ç½®ï¼ˆæ–°å¢éƒ¨åˆ†ï¼‰
WXPUSHER_TOKEN = os.getenv("WXPUSHER_APP_TOKEN")    # WxPusherçš„AppToken
TOPIC_IDS = os.getenv("WXPUSHER_TOPIC_IDS").split(',')  # åˆ†å‰²æˆæ•°ç»„ï¼ˆå¤šä¸ªä¸»é¢˜ç”¨é€—å·åˆ†éš”ï¼‰

# å¾®ä¿¡æ¨é€å‡½æ•°ï¼ˆæ–°å¢éƒ¨åˆ†ï¼‰
def wxpusher_push(content):
    """ä½¿ç”¨WxPusherè¿›è¡Œå¾®ä¿¡æ¨é€"""
    if not WXPUSHER_TOKEN or not TOPIC_IDS:
        print("æœªé…ç½®WxPusherç¯å¢ƒå˜é‡")
        return
        
    # æ„å»ºè¯·æ±‚å‚æ•°
    url = "https://wxpusher.zjiecode.com/api/send/message"
    headers = {'Content-Type': 'application/json'}
    payload = {
        "appToken": WXPUSHER_TOKEN,
        "content": content.replace('\n', '\n'),  # ä¿ç•™åŸå§‹æ¢è¡Œ
        "topicIds": TOPIC_IDS,      # ä¸»é¢˜IDæ•°ç»„
        "contentType": 2,           # 1è¡¨ç¤ºæ–‡å­—
        "uids": []                  # å¦‚æœä½¿ç”¨uidsæ¨é€åˆ™ä¸éœ€è¦topicIds
    }
    
    try:
        resp = requests.post(url, json=payload, headers=headers).json()
        if resp['code'] == 1000:
            print("ğŸ‰WxPusheræ¨é€æˆåŠŸ")
        else:
            print(f"WxPusheræ¨é€å¤±è´¥ï¼š{resp['msg']}")
    except Exception as e:
        print(f"æ¨é€è¯·æ±‚å¼‚å¸¸ï¼š{str(e)}")

for i in range(len(xmly_cookie)):
    print(f'å¼€å§‹ç¬¬{i + 1}ä¸ªå¸å·ç­¾åˆ°')
    url = 'https://hybrid.ximalaya.com/web-activity/signIn/v2/signIn?v=new '
    headers = {
        'Host': 'hybrid.ximalaya.com',
        'Content-Type': 'application/json',
        'Accept': '*/*',
        'X-Xuid-Fp': 'FISDYy0YZLgYhwIObU0_rmpz5ZIWc2doY1AQZ8xlyQk8pafpgABxMiE5LjAuNDMh',
        'Connection': 'keep-alive',
        'Cookie': f'{xmly_cookie[i]}',
        'User-Agent': 'ting_v9.0.87_c5(CFNetwork, iOS 15.6, iPhone14,5)',
        'Content-Length': '10',
        'Accept-Language': 'zh-CN,zh-Hans;q=0.9',
        'Accept-Encoding': 'gzip, deflate, br',
    }
    data='{"aid":87}'
    html = requests.post(url=url, headers=headers, data=data)
    result = json.loads(html.text)['data']['msg']
    print(result)

    m_url='https://m.ximalaya.com/business-vip-presale-mobile-web/page/ts-1671779856199?version=9.0.87'
    m_headers={
        'Host': 'm.ximalaya.com',
        'Accept': 'application/json, text/plain, */*',
        'Connection': 'keep-alive',
        'Cookie': f'{xmly_cookie[i]}',
        'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 15_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 iting/9.0.87 kdtunion_iting/1.0 iting(main)/9.0.87/ios_1 ;xmly(main)/9.0.87/iOS_1',
        'Accept-Language': 'zh-CN,zh-Hans;q=0.9',
        'Referer': 'https://m.ximalaya.com/gatekeeper/business-xmvip/main?app=iting&version=9.0.87&impl=com.gemd.iting&orderSource=app_Other_MyPage_VipCard',
        'Accept-Encoding': 'gzip, deflate, br',
    }
    m_html = requests.get(url=m_url, headers=m_headers)
    m_result = json.loads(m_html.text)['data']['modules'][0]['userInfo']
    info = 'ID: '+str(m_result['userId'])+ ' ç”¨æˆ·å: '+ m_result['nickName']+ ' VIPåˆ°æœŸæ—¥æœŸ: '+m_result['subtitle']
    print(info)
    
    # æ¨é€ç­¾åˆ°ç»“æœå’Œç”¨æˆ·ä¿¡æ¯ï¼ˆæ–°å¢éƒ¨åˆ†ï¼‰
    push_content = f"ğŸ‰ å–œé©¬æ‹‰é›…ç­¾åˆ°ç»“æœ ğŸ‰\n\n" \
                   f"ğŸ“ ç­¾åˆ°ç»“æœ: {result}\n" \
                   f"ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯: {info}"
    wxpusher_push(push_content)  # è°ƒç”¨å¾®ä¿¡æ¨é€å‡½æ•°