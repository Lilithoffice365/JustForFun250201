#!/usr/bin/python3
# -*- coding: utf-8 -*-
# -------------------------------
# @Author : github@wd210010 
# @Time : 2023/2/27 13:23
# -------------------------------
# cron "30 0 * * *" script-path=stl_sign.py,tag=STLXZç­¾åˆ°
# ä½¿ç”¨WxPusheræ¨é€éœ€é…ç½®ä¸¤ä¸ªç¯å¢ƒå˜é‡ï¼š
# 1. WXPUSHER_TOKEN (ä»wxpusher.zjiecode.comè·å–)
# 2. WXPUSHER_TOPIC_ID (æ¶ˆæ¯æ¥æ”¶ä¸»é¢˜ID)

import requests
import json
import os

# ------------------- é…ç½®åŒº -------------------
# ä»ç¯å¢ƒå˜é‡è¯»å–é…ç½®
STL_COOKIE = os.getenv("stl_cookie")      # STLXZçš„Cookie
WXPUSHER_TOKEN = os.getenv("WXPUSHER_APP_TOKEN")  # WxPusherçš„AppToken
TOPIC_ID = os.getenv("WXPUSHER_TOPIC_IDS")  # æ¶ˆæ¯æ¥æ”¶ä¸»é¢˜ID(çº¯æ•°å­—)

# ------------------- æ¨é€å‡½æ•° -------------------
def wxpusher_push(content):
    """
    ä½¿ç”¨WxPusherå‘é€æ¶ˆæ¯
    å‚æ•°ï¼šcontent (è¦æ¨é€çš„å­—ç¬¦ä¸²å†…å®¹)
    """
    if not all([WXPUSHER_TOKEN, TOPIC_ID]):
        print("æ¨é€å¤±è´¥ï¼šæœªé…ç½®WxPusherå‚æ•°ï¼")
        return

    api_url = "https://wxpusher.zjiecode.com/api/send/message"
    headers = {'Content-Type': 'application/json'}
    
    # æ³¨æ„ï¼štopicIdså¿…é¡»æ˜¯æ•´æ•°åˆ—è¡¨æ ¼å¼
    payload = {
        "appToken": WXPUSHER_TOKEN,
        "content": content.replace('\n', '<br>'),
        "topicIds": [int(TOPIC_ID)],  # è½¬æ¢ä¸ºæ•´æ•°åˆ—è¡¨
        "contentType": 2,             # 2è¡¨ç¤ºHTMLæ ¼å¼
        "verifyPay": False            # ä¸éœ€è¦ä»˜è´¹éªŒè¯
    }

    try:
        resp = requests.post(api_url, json=payload, headers=headers, timeout=10)
        result = resp.json()
        if result.get("code") == 1000:
            print("âœ… WxPusheræ¨é€æˆåŠŸ")
        else:
            print(f"æ¨é€å¤±è´¥ï¼š{result.get('msg')}")
    except Exception as e:
        print(f"æ¨é€è¯·æ±‚å¼‚å¸¸ï¼š{str(e)}")

# ------------------- ä¸»é€»è¾‘ -------------------
def main():
    # è¯·æ±‚å¤´
    headers = {
        'cookie': STL_COOKIE,
        'user-agent': 'Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.198 Safari/537.36',
        'origin': 'https://www.stlxz.com',
        'referer': 'https://www.stlxz.com/wl/wzzjc/12021.html'
    }

    # è¯·æ±‚æ•°æ®
    data = {'action': 'user_checkin'}
    url = 'https://www.stlxz.com/wp-admin/admin-ajax.php?action=checkin_details_modal'

    try:
        # å‘é€ç­¾åˆ°è¯·æ±‚
        response = requests.post(url=url, headers=headers, data=data, timeout=10)
        response.raise_for_status()  # æ£€æŸ¥HTTPçŠ¶æ€ç 

        # è§£æç»“æœ
        result = json.loads(response.text)['msg']
        print(f"ç­¾åˆ°ç»“æœï¼š{result}")

        # æ¨é€ç»“æœ
        message = (
            "ğŸ·ï¸ STLXZç­¾åˆ°ç»“æœ\n"
            f"ğŸ“… {result}\n"
            "â° æ•°æ®æ›´æ–°æ—¶é—´ï¼šæ¯æ—¥00:30"
        )
        wxpusher_push(message)

    except requests.exceptions.RequestException as e:
        print(f"ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼š{str(e)}")
    except json.JSONDecodeError:
        print("é”™è¯¯ï¼šè¿”å›æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼")
    except KeyError:
        print("é”™è¯¯ï¼šè¿”å›æ•°æ®ç¼ºå°‘'msg'å­—æ®µ")
    except Exception as e:
        print(f"æœªçŸ¥é”™è¯¯ï¼š{str(e)}")

if __name__ == "__main__":
    main()