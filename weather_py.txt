#!/usr/bin/python3
# -*- coding: utf-8 -*-

"""
åŸå¸‚ï¼š**
ä½œå“åç§°ï¼šå¤©æ°”æ¨é€è„šæœ¬ï¼ˆdeepseekä¿®æ”¹_å°ç™½å‹å¥½ç‰ˆï¼‰
åŠŸèƒ½ï¼šæ¯æ—¥è‡ªåŠ¨è·å–å¤©æ°”ä¿¡æ¯å¹¶é€šè¿‡å¾®ä¿¡æ¨é€
åŸä½œè€…ï¼šgithub@wd210010ï¼ˆä¿®æ”¹ç‰ˆï¼‰
"""

import os
import requests
import json

# ------------------- é…ç½®åŒºï¼ˆéœ€è¦ç”¨æˆ·ä¿®æ”¹çš„éƒ¨åˆ†ï¼‰ -------------------
# [é‡è¦] éœ€è¦å…ˆé…ç½®è¿™ä¸¤ä¸ªç¯å¢ƒå˜é‡å†è¿è¡Œè„šæœ¬ï¼

# 1. åŸå¸‚ä»£ç ï¼ˆä»ä¸‹æ–¹é“¾æ¥æŸ¥è¯¢ï¼Œä¾‹å¦‚åŒ—äº¬101010100ï¼‰
# æŸ¥è¯¢åœ°å€ï¼šhttps://fastly.jsdelivr.net/gh/Oreomeow/checkinpanel@master/city.json
CITY_CODE = os.getenv("city_code")

# 2. å¾®ä¿¡æ¨é€Tokenï¼ˆå¼€å‘æ–‡æ¡£&æ³¨å†Œåœ°å€ï¼šhttps://wxpusher.zjiecode.com/admin/app/listï¼‰
PUSH_TOKEN = os.getenv("WXPUSHER_APP_TOKEN")

# ------------------- å‡½æ•°å®šä¹‰åŒº -------------------

def get_weather(city_code):
    """
    è·å–å¤©æ°”æ•°æ®
    å‚æ•°ï¼šåŸå¸‚ä»£ç ï¼ˆå­—ç¬¦ä¸²ï¼‰
    è¿”å›ï¼šè§£æåçš„å¤©æ°”æ•°æ®å­—å…¸ æˆ– Noneï¼ˆå¤±è´¥æ—¶ï¼‰
    """
    try:
        # æ„å»ºè¯·æ±‚URL
        url = f"http://t.weather.itboy.net/api/weather/city/{city_code}"
        
        # å‘é€è¯·æ±‚ï¼ˆè®¾ç½®3ç§’è¶…æ—¶é˜²æ­¢å¡æ­»ï¼‰
        response = requests.get(url, timeout=3)
        response.raise_for_status()  # è‡ªåŠ¨æ£€æµ‹HTTPé”™è¯¯
        
        # è§£æJSONæ•°æ®
        data = json.loads(response.text)
        
        # æ£€æŸ¥å¿…è¦å­—æ®µæ˜¯å¦å­˜åœ¨
        if 'data' not in data or 'cityInfo' not in data:
            print("é”™è¯¯ï¼šå¤©æ°”APIè¿”å›çš„æ•°æ®æ ¼å¼å¼‚å¸¸")
            return None
            
        return data
        
    except requests.exceptions.RequestException as e:
        print(f"ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼š{str(e)}")
    except json.JSONDecodeError:
        print("é”™è¯¯ï¼šå¤©æ°”APIè¿”å›çš„æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼")
    return None

def format_weather(data):
    """
    æ ¼å¼åŒ–å¤©æ°”ä¿¡æ¯
    å‚æ•°ï¼šå¤©æ°”æ•°æ®å­—å…¸
    è¿”å›ï¼šæ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²
    """
    try:
        # ä»Šæ—¥å¤©æ°”ä¿¡æ¯
        today = data['data']['forecast'][0]
        msg = (
            f"ğŸŒŸ {data['cityInfo']['city']} å¤©æ°”é¢„æŠ¥\n"
            f"ğŸ“… æ—¥æœŸï¼š{today['ymd']} {today['week']}\n"
            f"â›… å¤©æ°”ï¼š{today['type']}\n"
            f"ğŸŒ¡ï¸ æ¸©åº¦ï¼š{today['low']} ~ {today['high']}\n"
            f"ğŸ’§ æ¹¿åº¦ï¼š{data['data']['shidu']}\n"
            f"ğŸƒ ç©ºæ°”è´¨é‡ï¼š{data['data']['quality']}\n"
            f"ğŸŒ€ é£åŠ›ï¼š{today['fx']} {today['fl']}\n"
            f"ğŸ“¢ æ¸©é¦¨æç¤ºï¼š{today['notice']}\n"
            f"ğŸ•’ æ›´æ–°æ—¶é—´ï¼š{data['time']}"
        )

        # æœªæ¥ä¸ƒå¤©é¢„æŠ¥
        seven_days = []
        for day in data['data']['forecast']:
            seven_days.append(
                f"{day['ymd']} {day['week']} {day['type']} "
                f"{day['low']}~{day['high']}"
            )
            
        return msg + "\n\næœªæ¥ä¸ƒå¤©é¢„æŠ¥ï¼š\n" + "\n".join(seven_days)
        
    except KeyError as e:
        print(f"é”™è¯¯ï¼šå¤©æ°”æ•°æ®ç¼ºå°‘å¿…è¦å­—æ®µ - {str(e)}")
        return None

def push_message(content):
    """
    å‘é€å¾®ä¿¡æ¨é€
    å‚æ•°ï¼šè¦å‘é€çš„å†…å®¹ï¼ˆå­—ç¬¦ä¸²ï¼‰
    """
    if not PUSH_TOKEN:
        print("é”™è¯¯ï¼šæœªé…ç½®æ¨é€Tokenï¼")
        return

    api_url = "https://wxpusher.zjiecode.com/api/send/message"
    headers = {'Content-Type': 'application/json'}
    
    payload = {
        "appToken": PUSH_TOKEN,
        "title": "æ¯æ—¥å¤©æ°”æ¨é€",
        "content": content.replace('\n', '<br>'),
        "template": "txt",
        "topicIds": [30***]     #ä½¿ç”¨ä½ è‡ªå·±çš„topicIDsæˆ–è€…å‚è€ƒå¼€å‘æ–‡æ¡£"uids": [UID_C.********]
    }

    try:
        response = requests.post(api_url, json=payload, headers=headers, timeout=5)
        result = response.json()
        if result['code'] == 1000:
            print("âœ… æ¨é€æˆåŠŸï¼")
        else:
            print(f"æ¨é€å¤±è´¥ï¼š{result.get('msg', 'æœªçŸ¥é”™è¯¯')}")
    except Exception as e:
        print(f"æ¨é€è¯·æ±‚å¤±è´¥ï¼š{str(e)}")

# ------------------- ä¸»ç¨‹åº -------------------
if __name__ == "__main__":
    # æ£€æŸ¥ç¯å¢ƒå˜é‡
    if not CITY_CODE:
        print("é”™è¯¯ï¼šè¯·å…ˆè®¾ç½®ç¯å¢ƒå˜é‡ city_code")
        exit(1)
    if not PUSH_TOKEN:
        print("è­¦å‘Šï¼šæœªé…ç½®æ¨é€Tokenï¼Œä»…æµ‹è¯•å¤©æ°”è·å–")

    # è·å–å¤©æ°”æ•°æ®
    weather_data = get_weather(CITY_CODE)
    if not weather_data:
        print("è·å–å¤©æ°”æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥åŸå¸‚ä»£ç ")
        exit(1)

    # æ ¼å¼åŒ–ä¿¡æ¯
    formatted_msg = format_weather(weather_data)
    if not formatted_msg:
        print("æ ¼å¼åŒ–å¤©æ°”æ•°æ®å¤±è´¥")
        exit(1)

    # æ‰“å°é¢„è§ˆï¼ˆæµ‹è¯•ç”¨ï¼‰
    print("="*30 + "\né¢„è§ˆå†…å®¹ï¼š\n" + formatted_msg + "\n" + "="*30)

    # å‘é€æ¨é€
    if PUSH_TOKEN:
        push_message(formatted_msg)
    else:
        print("ï¼ˆæœªå‘é€æ¨é€ï¼Œå› æœªé…ç½®Tokenï¼‰")